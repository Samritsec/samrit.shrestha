{% extends "dashboard_base.html" %}
{% block page_title %}Organization Admin Dashboard{% endblock %}
{% block inner %}

<!-- KPIs -->
<div class="kpis">
  <div class="kpi">
    <div class="kpi-label">Total Devices</div>
    <div class="kpi-value" id="kpi-devices" data-base="{{ agg.total }}">{{ agg.total }}</div>
    <div class="kpi-trend" id="kpi-devices-trend">—</div>
  </div>
  <div class="kpi">
    <div class="kpi-label">Online</div>
    <div class="kpi-value">{{ agg.online }}</div>
    <div class="kpi-trend">Uptime {{ agg.uptime_pct }}%</div>
  </div>
  <div class="kpi">
    <div class="kpi-label">Unusual Activity</div>
    <div class="kpi-value" id="kpi-alerts" data-base="{{ agg.unusual }}">{{ agg.unusual }}</div>
    <div class="kpi-trend" id="kpi-alerts-trend">—</div>
  </div>
  <div class="kpi">
    <div class="kpi-label">Last Sign-in (any device)</div>
    <div class="kpi-value">
      {% if agg.last_login %}{{ agg.last_login.strftime("%Y-%m-%d %H:%M") }} UTC{% else %}—{% endif %}
    </div>
    <div class="kpi-trend">Live uptime: <span id="kpi-uptime">00:00:00</span></div>
  </div>
</div>

<!-- At-Risk Devices Panel -->
<div class="panel" style="margin-bottom:16px;">
  <div class="panel-head">
    <h3 class="panel-title">At-Risk Devices</h3>
    <div class="panel-actions">
      <button class="btn ghost btn-sm" id="btnViewAtRisk">View History</button>
    </div>
  </div>
  <div class="panel-body">
    <table class="tg-table">
      <thead>
        <tr><th>Host</th><th>Issue</th><th>Severity</th><th>Last Detected</th><th>Mitigation</th></tr>
      </thead>
      <tbody id="riskTableBody">
        <tr>
          <td>gateway-04</td>
          <td>Malware Flag</td>
          <td><span class="pill pill-warn">High</span></td>
          <td>2025-10-21 13:45 UTC</td>
          <td>Isolate endpoint &amp; scan</td>
        </tr>
        <tr>
          <td>server-12</td>
          <td>Brute Force Login</td>
          <td><span class="pill pill-bad">Critical</span></td>
          <td>2025-10-21 11:20 UTC</td>
          <td>Reset admin credentials</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Mini Charts -->
<div class="mini-charts">
  <div class="mini-card">
    <div class="mini-head">
      <div>
        <div class="mini-title">Threat Trend (24h)</div>
        <div class="mini-sub">Incidents detected per period</div>
      </div>
    </div>
    <div class="mini-body"><canvas id="chartThreats"></canvas></div>
  </div>

  <div class="mini-card">
    <div class="mini-head">
      <div>
        <div class="mini-title">CPU Load</div>
        <div class="mini-sub">Average % per interval (threshold 85%)</div>
      </div>
      <button class="btn ghost btn-sm" id="btnViewCpuHeavy">View heavy</button>
    </div>
    <div class="mini-body"><canvas id="chartCPU"></canvas></div>
  </div>

  <div class="mini-card">
    <div class="mini-head">
      <div>
        <div class="mini-title">Memory Load</div>
        <div class="mini-sub">Average % per interval (threshold 85%)</div>
      </div>
      <button class="btn ghost btn-sm" id="btnViewMemHeavy">View heavy</button>
    </div>
    <div class="mini-body"><canvas id="chartMEM"></canvas></div>
  </div>

  <div class="mini-card">
    <div class="mini-head">
      <div>
        <div class="mini-title">Status Split</div>
        <div class="mini-sub">Device State Distribution</div>
      </div>
    </div>
    <div class="mini-body"><canvas id="chartStatus"></canvas></div>
  </div>
</div>

<!-- Grid: Events + Devices -->
<div class="grid-2">
  <!-- Recent Events -->
  <div class="panel">
    <div class="panel-head">
      <h3 class="panel-title">Recent Security Events</h3>
      <div class="panel-actions"><button id="btn-refresh-events" class="btn ghost">Refresh</button></div>
    </div>
    <div class="panel-body">
      <!-- Table version for readability -->
      <div class="events-table">
        <table class="tg-table">
          <thead>
            <tr><th>Severity</th><th>Event</th><th>Timestamp</th><th>Description</th></tr>
          </thead>
          <tbody>
            {% for e in events %}
            <tr>
              <td><span class="badge sev sev-{{ e.severity }}">{{ e.severity|title }}</span></td>
              <td>{{ e.event_type }}</td>
              <td>{{ e.timestamp.strftime("%Y-%m-%d %H:%M") }} UTC</td>
              <td>{{ e.description }}</td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="muted">No recent alerts — All clear ✅</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Devices -->
  <div class="panel">
    <div class="panel-head">
      <h3 class="panel-title">Devices</h3>
      <div class="panel-actions">
        <button class="btn ghost btn-sm" id="btnAddDevice">+ Add Device</button>
        <button class="btn ghost btn-sm" id="btnAddAgent">+ Add Agent</button>
      </div>
    </div>
    <div class="panel-body">
      <div class="table-wrap">
        <table class="tg-table">
          <thead>
            <tr><th>Host</th><th>OS</th><th>IP</th><th>Status</th><th>CPU</th><th>Mem</th><th>Last Seen</th></tr>
          </thead>
          <tbody>
            {% for d in devices %}
            <tr class="{% if d.unusual %}row-warn{% endif %}">
              <td>{{ d.hostname }}</td>
              <td>{{ d.os }}</td>
              <td>{{ d.ip }}</td>
              <td>{% if d.status == 'online' %}<span class="pill pill-ok">Online</span>{% else %}<span class="pill pill-bad">Offline</span>{% endif %}</td>
              <td>{{ d.cpu }}%</td>
              <td>{{ d.mem }}%</td>
              <td>{{ d.last_seen.strftime("%Y-%m-%d %H:%M") }} UTC</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Floating Buttons -->
<div class="panel-actions" style="margin-top:14px; text-align:right;">
  <button class="btn ghost btn-sm" id="btnAddUser">+ Add User</button>
  <button class="btn ghost btn-sm" id="btnGenerateReport">Generate Report</button>
</div>

<!-- ===== Inline Modals (replace missing partials) ===== -->
<!-- Heavy Load Modal -->
<div class="modal-mask" id="heavyModal" aria-hidden="true" role="dialog" aria-labelledby="heavyTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="heavyTitle">Heavy Load Devices</h3>
      <button class="icon-btn" id="heavyClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <div class="table-wrap">
        <table class="tg-table">
          <thead>
            <tr><th>Host</th><th>OS</th><th>IP</th><th>Status</th><th>CPU</th><th>Mem</th><th>Last Seen</th></tr>
          </thead>
          <tbody id="heavyTableBody"><tr><td colspan="7">Loading…</td></tr></tbody>
        </table>
      </div>
      <div class="muted mt-2" id="heavyCount"></div>
    </div>
  </div>
</div>

<!-- At-Risk History Modal -->
<div class="modal-mask" id="atRiskModal" aria-hidden="true" role="dialog" aria-labelledby="atRiskTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="atRiskTitle">At-Risk History</h3>
      <button class="icon-btn" id="atRiskClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <div class="table-wrap">
        <table class="tg-table">
          <thead>
            <tr><th>Date</th><th>Host</th><th>Issue</th><th>Severity</th><th>Details</th></tr>
          </thead>
          <tbody id="atRiskTableBody"><tr><td colspan="5">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal-mask" id="addUserModal" aria-hidden="true" role="dialog" aria-labelledby="addUserTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="addUserTitle">Add User</h3>
      <button class="icon-btn" id="addUserClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <form id="addUserForm" class="tg-form">
        <div class="grid-2">
          <div><label>Username</label><input name="username" required></div>
          <div><label>Email</label><input name="email" type="email" required></div>
        </div>
        <div class="grid-2">
          <div><label>Password</label><input name="password" type="password" required></div>
          <div><label>Role</label>
            <select name="role" required>
              <option value="user">User</option>
              <option value="analyst">Analyst</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div style="text-align:right; margin-top:10px;">
          <button type="submit" class="btn ghost btn-sm">Create</button>
        </div>
      </form>
      <div id="addUserMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<!-- Add Device Modal -->
<div class="modal-mask" id="addDeviceModal" aria-hidden="true" role="dialog" aria-labelledby="addDeviceTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="addDeviceTitle">Add Device</h3>
      <button class="icon-btn" id="addDeviceClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <form id="addDeviceForm" class="tg-form">
        <div class="grid-2">
          <div><label>Hostname</label><input name="hostname" required></div>
          <div><label>OS</label><input name="os" required></div>
        </div>
        <div class="grid-2">
          <div><label>IP</label><input name="ip" required></div>
          <div><label>Status</label>
            <select name="status"><option>online</option><option>offline</option></select>
          </div>
        </div>
        <div style="text-align:right; margin-top:10px;">
          <button type="submit" class="btn ghost btn-sm">Add</button>
        </div>
      </form>
      <div id="addDeviceMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<!-- Add Agent Modal -->
<div class="modal-mask" id="addAgentModal" aria-hidden="true" role="dialog" aria-labelledby="addAgentTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="addAgentTitle">Add Agent</h3>
      <button class="icon-btn" id="addAgentClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <form id="addAgentForm" class="tg-form">
        <div class="grid-2">
          <div><label>Device Hostname</label><input name="hostname" required></div>
          <div><label>Agent Version</label><input name="agent_version" required></div>
        </div>
        <div style="text-align:right; margin-top:10px;">
          <button type="submit" class="btn ghost btn-sm">Install</button>
        </div>
      </form>
      <div id="addAgentMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<!-- Generate Report Modal -->
<div class="modal-mask" id="reportModal" aria-hidden="true" role="dialog" aria-labelledby="reportTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="reportTitle">Generate Report</h3>
      <button class="icon-btn" id="reportClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <form id="reportForm" class="tg-form">
        <div class="grid-2">
          <div>
            <label>Range</label>
            <select name="range">
              <option value="24h">Last 24 hours</option>
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
            </select>
          </div>
          <div>
            <label>Format</label>
            <select name="format">
              <option value="pdf">PDF</option>
              <option value="csv">CSV</option>
            </select>
          </div>
        </div>
        <div style="text-align:right; margin-top:10px;">
          <button type="submit" class="btn ghost btn-sm">Generate</button>
        </div>
      </form>
      <div id="reportMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>
</div>
<!-- ===== End Inline Modals ===== -->

<!-- Ensure solid backgrounds for readability (in case CSS didn’t load yet) -->
<style>
.panel-body, .events-table, .modal-body, .table-wrap { background: rgba(20,28,36,.9); border-radius: 10px; }
.tg-table th, .tg-table td { color: #d7e0ea; }
</style>

<!-- Data for JS + scripts (defer execution until DOM exists) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<script>
  window.DASHBOARD_DATA = {
    threats: {{ trend_threats|tojson or [] }},
    cpu: {{ trend_cpu|tojson or [] }},
    mem: {{ trend_mem|tojson or [] }},
    statusCounts: {{ status_counts|tojson or {"online":0,"offline":0,"unusual":0} }}
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
{% endblock %}
